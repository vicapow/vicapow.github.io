<!DOCTYPE html>
<html>
  <head>
      <link href='http://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>
      <style>
      body{
        font-family: 'Roboto', helvetica, sans-serif;
      }
      .door text, .bar text{
        stroke: none;
        text-anchor: middle;
      }
      .door line{
        stroke: white;
        stroke-width: 3;
      }
      .door .prize rect{
        fill: green;
      }
      .door .prize rect.goat{
        fill: red;
      }
      .door .cover text{
        fill: white;
      }
      .door .cover{
        fill: black;
      }
      .select{
        fill: none;
        opacity: 0.5;
        stroke: white;
      }
      body { 
        margin: 0;
      }
      label, select {
        /*font-size: 20px;*/
      }
      .bar rect.bg{
        fill: white;
      }
      .bar rect.wins{
        fill: green;
      }
      .stickers {
        display: none;
      }
    </style>
  </head>
  <body>
    <label>strategy</label>
    <select class="strategy">
      <option value="stay">stay</option>
      <option value="switch">switch</option>
    </select>
    <label>doors</label>
    <select class="doors"></select>
    <label>duration</label>
    <input type="number" class="duration" min="0" max="8000" value="8000" step="1000" />
    <svg>
      <g class="stickers">
        <g class="goat">
          <path d="M5.842,19.803c0.566,1.698,2.398,1.526,3.139,1.613c0.741,0.087,1.613-0.807,1.613-0.807s0.453-3.117,0.226-4.076  s-1.098-4.316-0.924-4.97c0.174-0.654,1.482-4.185,1.482-4.185s-2.834,3.139-3.182,4.185c-0.349,1.046-0.959,3.313-1.308,4.534  C6.539,17.318,5.362,18.365,5.842,19.803z"/>
<path d="M14.11,4.196c0.241,0.185,1.424-0.552,1.918-0.465c0.494,0.087,1.046,0.227,1.046,0.227S16.9,1.087,15.593,1.057  S13.733,3.906,14.11,4.196z"/>
<path d="M30.444,62.09c0,0,2.848,0.174,4.301,1.744s2.383,4.766,2.441,6.51c0.058,1.744-0.233,6.626,0,8.312  s1.453,4.883,1.686,5.638c0.233,0.756-1.221,7.324-1.221,7.324s-0.291-5.057-0.639-7.324c-0.349-2.267-1.951-5.173-2.342-6.975  c-0.39-1.802-0.158-3.313-0.565-5.115c-0.407-1.802-2.267-3.662-2.616-5.522S30.444,62.09,30.444,62.09z"/>
<path d="M70.842,68.368c0,0,2.616,1.628,3.371,3.081c0.756,1.453,0,6.394,0,6.394s-4.301,9.416-5.057,10.928  c-0.756,1.511-3.604,7.556-3.604,7.556h4.301c0,0,0.116-1.163,1.104-1.569c0.988-0.407,0-2.267,0.93-2.441s2.125-0.639,2.661-0.872  s-0.394-3.197,0.478-4.941c0.872-1.744,2.034-6.801,3.371-7.615c1.337-0.814,2.209-1.918,2.209-1.918s-0.814-3.894-0.233-5.58  c0.581-1.686,1.744-2.616,1.744-2.616l-3.546-6.568c0,0-1.86,3.546-2.616,4.069C75.201,66.798,70.842,68.368,70.842,68.368z"/>
<path d="M93.511,79.354c0.436-2.441,1.046-4.708,0.61-6.365c-0.436-1.657-3.313-8.835-2.79-11.262  c0.523-2.427,0.61-12.977,0.61-15.505s-2.877-6.278-2.877-6.278s2.093-2.528,2.703-4.359c0.61-1.831-0.698-1.133-0.698-1.133  s0.262-2.267-1.657-4.011c-1.918-1.744-6.19-3.226-6.19-3.226s4.011,3.081,4.447,6.365c0.067,0.506-1.133,1.112-2.267,1.569  c-2.357,0.952-12.468-1.221-17.525-1.133c-5.057,0.087-14.561,1.221-15.781,0.785c-1.221-0.436-5.057-2.703-6.278-3.836  c-1.221-1.133-7.934-1.918-7.934-1.918l-5.057-5.885c0,0-0.741,0.218-2.354,0c-1.613-0.218-4.447-2.18-4.97-3.836  c-0.523-1.657-0.131-4.534-0.305-5.842s-2.746-5.144-2.746-5.144s2.746,3.052,3.27,4.621s-0.392,5.493,0.349,6.147  c0.741,0.654,3.139,3.531,4.534,3.531s5.231-1.657,3.27-5.929c-1.962-4.272-5.493-6.278-6.016-7.716s-2.616-2.485-2.616-2.485  s2.18-3.793,3.575-3.924s6.583,1.221,6.583,1.221s-3.924-3.444-6.626-3.575s-7.28,4.665-7.28,4.665s-5.319-0.523-6.801-0.174  s-1.7,2.485-2.267,3.095c-0.567,0.61-1.831,2.746-1.569,3.836s0.61,3.139,0.567,4.708c-0.044,1.569-0.436,6.83-0.218,7.949  c0.147,0.753,0.965,1.208,1.519,1.538c0.359-0.07,0.687-0.145,0.857-0.201c0.458-0.153,2.354-0.654,2.768-0.828  c0.414-0.174,1.657-1.264,1.657-1.264s-1.024,1.569-1.417,1.766s-1.155,0.458-1.809,0.654c-0.394,0.118-0.898,0.268-1.313,0.412  c0.572,0.439,1.538,1.109,2.098,1.296c0.698,0.233,3.429-1.046,3.429-1.046s2.093,5.348,2.906,7.905  c0.814,2.558,3.139,6.103,3.72,7.905c0.581,1.802-0.116,6.103,0.407,7.673c0.523,1.569,1.86,6.917,2.616,8.37  c0.756,1.453,3.546,3.197,4.999,3.546c1.453,0.349,3.604,2.848,3.662,4.011c0.058,1.163,1.017,5.464,1.017,7.556  s-0.174,4.447,0,6.19c0.174,1.744,1.831,3.836,1.308,6.626c-0.523,2.79-3.488,12.73-3.488,12.73h5.057c0,0,1.482-2.093,2.354-2.616  c0.872-0.523-0.436-2.093,0-3.313c0.436-1.221,0.785-2.093,0.698-3.139c-0.087-1.046-1.046-4.359-0.785-6.714  c0.262-2.354,1.657-4.447,1.831-5.929c0.174-1.482-1.744-5.58-1.482-7.237c0.262-1.657,1.569-5.231,2.877-5.929  c1.308-0.698,2.703,1.657,5.493,2.005c2.79,0.349,11.858,2.005,16.304,1.482c4.447-0.523,7.411-2.79,8.021-3.139  c0.61-0.349,2.267-4.97,2.267-4.97s3.139,8.37,4.708,10.027c1.569,1.657,4.185,4.272,4.621,5.842  c0.436,1.569,1.395,10.986,0.785,12.904c-0.61,1.918-3.026,7.905-3.026,7.905h4.203c0,0,0.566-4.156,1.613-5.028  c1.046-0.872,1.308-1.918,1.831-2.616S93.075,81.795,93.511,79.354z M22.103,13.09c-0.581,0.349-2.296,0-2.296,0  s-0.087-1.715,0.639-1.976s1.744-0.203,1.889,0.262C22.481,11.84,22.684,12.741,22.103,13.09z"/>
<path d="M21.757,11.881c0.204-0.02,0.385,0.129,0.405,0.333c0.02,0.204-0.129,0.385-0.333,0.405l-1.045,0.102  c-0.204,0.02-0.385-0.129-0.405-0.333c-0.02-0.204,0.129-0.385,0.333-0.405L21.757,11.881z"/>
        </g>
        <g class="car">
<path d="M13.925,74.058c-3.67-0.323-6.377-3.559-6.053-7.226c0.325-3.667,3.568-6.373,7.229-6.047  c3.666,0.327,6.375,3.563,6.05,7.227C20.825,71.679,17.585,74.385,13.925,74.058 M15.533,55.96  c-6.329-0.562-11.92,4.112-12.484,10.442C2.488,72.733,7.163,78.32,13.493,78.884c6.329,0.56,11.921-4.111,12.481-10.445  C26.536,62.108,21.857,56.523,15.533,55.96"/>
<path fill="#000000" d="M14.501,56.628c0.321,0,0.647,0.015,0.968,0.043c5.925,0.527,10.319,5.778,9.793,11.705  c-0.239,2.705-1.477,5.2-3.483,7.025c-1.995,1.814-4.572,2.813-7.258,2.813c-0.32,0-0.645-0.015-0.964-0.043  c-5.926-0.528-10.321-5.78-9.796-11.707c0.241-2.703,1.478-5.197,3.485-7.023C9.24,57.628,11.816,56.628,14.501,56.628   M14.524,74.799c1.834,0,3.594-0.683,4.957-1.923c1.372-1.249,2.218-2.954,2.382-4.802c0.36-4.051-2.645-7.64-6.698-8.001  c-0.219-0.02-0.44-0.029-0.659-0.029c-1.835,0-3.597,0.683-4.961,1.923c-1.374,1.249-2.22,2.954-2.384,4.802  c-0.173,1.964,0.428,3.878,1.693,5.389c1.266,1.512,3.045,2.439,5.009,2.612C14.082,74.789,14.304,74.799,14.524,74.799   M14.501,55.914c-5.894,0-10.919,4.504-11.452,10.488C2.488,72.733,7.163,78.32,13.493,78.884c0.345,0.03,0.688,0.045,1.028,0.045  c5.896,0,10.923-4.501,11.453-10.49c0.562-6.331-4.117-11.917-10.441-12.479C15.187,55.929,14.842,55.914,14.501,55.914  L14.501,55.914z M14.524,74.084c-0.198,0-0.397-0.009-0.599-0.026c-3.67-0.323-6.377-3.559-6.053-7.226  c0.307-3.466,3.222-6.074,6.633-6.074c0.197,0,0.396,0.009,0.596,0.026c3.666,0.327,6.375,3.563,6.05,7.227  C20.843,71.478,17.932,74.084,14.524,74.084L14.524,74.084z"/>
<path d="M82.773,74.058c-3.666-0.323-6.375-3.559-6.049-7.226c0.327-3.667,3.565-6.373,7.231-6.047  c3.664,0.327,6.37,3.563,6.05,7.227C89.678,71.679,86.438,74.385,82.773,74.058 M84.386,55.96  c-6.331-0.562-11.925,4.112-12.483,10.442c-0.566,6.331,4.114,11.917,10.442,12.482c6.328,0.56,11.922-4.111,12.482-10.445  C95.388,62.108,90.711,56.523,84.386,55.96"/>
<path fill="#000000" d="M83.354,56.628c0.321,0,0.647,0.015,0.969,0.043c5.924,0.527,10.317,5.777,9.792,11.705  c-0.239,2.705-1.477,5.2-3.484,7.025c-1.995,1.814-4.573,2.813-7.259,2.813c-0.32,0-0.645-0.015-0.964-0.043  c-2.872-0.256-5.472-1.614-7.322-3.825c-1.851-2.211-2.729-5.011-2.472-7.882c0.238-2.703,1.475-5.196,3.482-7.022  C78.091,57.628,80.669,56.628,83.354,56.628 M83.373,74.799c1.836,0,3.598-0.683,4.961-1.923c1.372-1.248,2.218-2.953,2.383-4.802  c0.354-4.051-2.651-7.64-6.698-8c-0.219-0.02-0.441-0.029-0.66-0.029c-1.836,0-3.599,0.683-4.962,1.923  c-1.373,1.248-2.219,2.953-2.384,4.802c-0.175,1.964,0.426,3.878,1.692,5.39c1.265,1.511,3.043,2.438,5.005,2.611  C82.93,74.789,83.152,74.799,83.373,74.799 M83.354,55.914c-5.896,0-10.924,4.504-11.452,10.488  c-0.566,6.331,4.114,11.917,10.442,12.482c0.345,0.03,0.688,0.045,1.028,0.045c5.896,0,10.925-4.501,11.454-10.49  c0.561-6.331-4.116-11.917-10.441-12.479C84.04,55.929,83.696,55.914,83.354,55.914L83.354,55.914z M83.373,74.084  c-0.199,0-0.398-0.009-0.6-0.026c-3.666-0.323-6.375-3.559-6.049-7.226c0.309-3.466,3.22-6.074,6.634-6.074  c0.198,0,0.396,0.009,0.597,0.026c3.664,0.327,6.37,3.563,6.05,7.227C89.696,71.478,86.785,74.084,83.373,74.084L83.373,74.084z"/>
<path d="M23.373,38.428c0,0-0.606-11.975,5.685-13.802c6.293-1.826,17.859,0,17.859,0s23.343,6.899,28.819,18.062L23.373,38.428z   M94.312,58.519c-0.75-2.61-0.919-6.798-0.919-6.798l-5.886-6.798l-1.576-0.928l-2.99-1.71c0,0-25.445-19.626-35.216-20.499  c-23.449-2.096-31.112,1.028-33.205,2.325c1.775-0.077,5.391-0.063,4.541,1.401c-1.111,1.924-6.692,14.236-6.692,14.236  l-2.542-1.925l4.683-10.868c0,0,1.514-0.936-0.504-2.488c-0.119,0.1-0.174,0.16-0.174,0.16l-7.509,16.34  c1.015,8.522-1.22,10.655-1.22,10.655c-2.206,4.635-2.311,9.988-1.947,13.907c0.975-5.881,6.336-10.106,12.372-9.573  c6.332,0.563,11.012,6.151,10.449,12.484c-0.081,0.927-0.272,1.819-0.562,2.665H72.45c-0.496-1.471-0.702-3.062-0.555-4.702  c0.559-6.336,6.153-11.011,12.485-10.447c6.333,0.563,11.012,6.151,10.452,12.484c-0.083,0.927-0.275,1.819-0.559,2.665h0.749  C99.893,61.969,94.312,58.519,94.312,58.519"/>
        </g>
      </g>
    </svg>
    <script src="../../js/d3.js"></script>
    <script src="../../js/jquery-1.10.2.js"></script>
    <script src="../../js/sticker.js"></script>
    <script src="misc.js"></script>
    <script>
      var w = window.innerWidth
        , h = card.height
        , goat_sticker = d3.sticker(d3.select('.stickers .goat').node())
        , car_sticker = d3.sticker(d3.select('.stickers .car').node())
        , duration = 2000
        , max_doors = 40
        , bar_height = 30
        , n = 3
        , spacing = w / n
        , translate = function(x, y){ return 'translate(' + x + ',' + y + ')' }
        , selected // the door highlight border
        , doors // all the doors
        , covers
        , prizes // the prizes underneath
        , selected_door
        , strategy = 'stay'
        , font_size = 40
        , padding = 50
        , wins = 0
        , loses = 0

      var svg = d3.select('svg')
        .attr({width: w, height: h + bar_height + 4})


      // wire-up the `strategy` control
      d3.select('.strategy').on('change', function(){ 
        strategy = this.value
        restart()
      })

      // wire-up the `duration` control
      d3.select('.duration').on('change', function(){ 
        duration = Number(this.value) / 4
      }).attr('value', duration * 4)

      // wire-up the `number-of-doors` control
      d3.select('.doors')
        .on('change', function(){
          n = Number(this.value)
          restart()
        })
        .selectAll('option').data(d3.range(max_doors - 2))
          .enter().append('option').text(function(d){
            this.value = d + 3
            return d + 3
          })

      function restart(){
        wins = 0; loses = 0
        update_bar()
        svg.selectAll('.door').remove()
        kill_transitions()
        create_doors()
        new_game()
      }

      function new_game(){
        data = game_data(n)
        update_doors()
        select_door()
      }

      function create_doors(){
        data = game_data(n)
        spacing = w / n
        font_size = spacing / 5
        doors = svg.selectAll('g.door').data(data).enter()
          .append('g').attr({ 'class': 'door'
            , transform: function(d){
              return translate(d.number * spacing + spacing * 0.5, h / 2)
            }
          })

        prizes = doors.append('g').attr('class', 'prize')
        prizes.append('rect').attr({
            x: -spacing / 2
          , y: -h / 2
          , width: spacing
          , height: h
        })
        prizes.append('text').style('font-size', font_size + 'px')
        
        covers = doors.append('g').attr('class', 'cover')
        covers.append('rect').attr({ 
            x: -spacing / 2
          , y: -h / 2
          , width: spacing
          , height: h
        })
        
        covers.append('text')
          .text(function(d, i){ return d.number + 1 })
          .attr('y', font_size/3)
          .style('font-size', font_size + 'px')

        doors.append('line').attr({
            x1: -spacing / 2
          , x2: -spacing / 2
          , y1: -h / 2
          , y2:  h / 2
        })
        svg.selectAll('g.door:nth-child(1) line').remove()

        // create the door border highlight box
        var border = spacing / 20
        selected = svg.append('g').attr('class', 'select')
          .append('rect').attr({
              x: border
            , y: border
            , width: spacing - border * 2
            , height: h - border * 2
          })
          .style('stroke-width', border * 2)
      }

      function update_doors(){
        covers.attr('transform', translate(0, 0))
        doors.data(data)
        prizes.data(data).select('rect')
          .classed('goat', function(d){ return d.content === 'goat' })
        prizes.selectAll('.sticker').remove() // remove old stickers
        prizes.each(function(d){
          var me = d3.select(this).append('g')
          if(d.content === 'car') sticker = car_sticker(me)
          else sticker = goat_sticker(me)
          sticker.classed('sticker', true)
            .attr('transform', translate(-50, -50))
          me.attr('transform', 'scale(' + spacing / 300 + ')')
        })
      }

      function select_door(){
        selected_door = Math.floor(Math.random() * n)
        var door = data[selected_door]
        selected.style('opacity', '0').attr({
          'transform' : 'translate(' + (selected_door * spacing) + ',0)'
        }).transition().duration(duration)
          .style('opacity', '1')
          .each('end', revealGoats.bind(null, doors))
      }

      function revealGoats(doors){

        // randomize the doors
        var open = doors.data().map(function(door){
          door.open = door.number !== selected_door && door.content === 'goat'
          return door
        })

        if(data[selected_door].content === 'car'){
          // make sure not to open all the remaining doors if the play
          // picked the car!
          other_doors = open.slice(0)
          other_doors.splice(selected_door, 1)
          other_doors = shuffle(other_doors)
          // randomly close an additional door close an additional door
          other_doors[0].open = false
        }

        var count = 0 // done count
        var open_doors = doors.data(open).select('.cover')
          .filter(function(d){ return d.open })
          .attr('transform', translate(0, 0)).transition().duration(duration)
          .attr('transform', translate(0, -h))
          .each('end', function(){
            if(++count === open_doors.length) switchOrStay()
          })
      }

      function kill_transitions(){
        if(!doors) return
        doors.select('.cover').interrupt()
        doors.interrupt()
        selected.interrupt()
      }
      
      function switchOrStay(){
        if(strategy === 'stay') return reveal()
        // switch to the closed door
        var prev = selected_door
        selected_door = doors.data().filter(function(d, i){ 
          return !d.open && d.number !== selected_door
        })[0].number
        selected.attr({'transform':'translate(' + (prev * spacing) + ',0)'})
          .transition().duration(duration)
          .attr({'transform':'translate(' + (selected_door * spacing) + ',0)'})
          .each('end', reveal)
      }

      function reveal(){
        var count = 0
        var open_doors = doors.filter(function(d, i){ return !d.open })
          .select('.cover')
          .attr('transform', translate(0, 0))
          .transition().duration(duration).attr('transform', translate(0, -h))
          .each('end', function(){
            if(++count !== open_doors.length) return
            setTimeout(new_game, duration)
            if(data[selected_door].content === 'car') wins++
            else loses++
            update_bar()
          })
      }

      // generate the prize data for a new game
      function game_data(n){
        // add the goats
        var data = d3.range(n).map(function(d){ 
          return { content: 'goat', open: false, number: d }
        })
        // pick a door to put the car in
        data[Math.floor(Math.random() * n)].content = 'car'
        return data
      }

      restart()

      // add win/loss bar graph
      var bar = svg.append('g').attr('transform', translate(0, card.height + 10))
        .attr('class', 'bar')
        x = d3.scale.linear().domain([0, 1]).range([0, w])
      bar.append('rect').attr({
        x: 0, y: 0, width: w, height: bar_height, 'class': 'bg'
      })
      bar.append('rect').attr({
        x: 0, y: 0, width: x(0), height: bar_height, 'class': 'wins'
      })
      var label = bar.append('text').text('0% wins (0 out of 0)')
        .style('text-anchor', 'start')
        .attr({x: 5, y: bar_height / 2 })
      var percent = d3.format('%')

      function update_bar(){
        if(!bar) return
        var p = wins/(wins+loses)
        if(isNaN(p)) p = 0
        bar.select('.wins').transition().duration(duration)
          .attr({width: x(p)})
        label.text(percent(p) + ' wins ' + '(' + wins + ' out of ' + (wins+loses) + ')')
        var bb = label.node().getBBox()
        label.transition().duration(duration)
          .attr('x', x(p) + (x(p) + bb.width + 5 > w ?  - bb.width - 5 : 5))
      }

    </script>